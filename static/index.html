<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <style>
        ol.ais-InfiniteHits-list {
            list-style-type: none;
        }
    </style>
</head>
<body class="mx-4 mt-2">
<h1>Zeno Scraper</h1>
<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Modal title</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Enter the API Key</p>
                <input type="password" id="apiKey" name="apiKey">
            </div>
            <div class="modal-footer">
                <button id="apiKeyBtn" type="button" class="btn btn-primary" data-bs-dismiss="modal">Save</button>
            </div>
        </div>
    </div>
</div>
<div class="mb-3">
    <button id="refreshBtn" class="btn btn-primary p-1 me-2">Refresh</button>
    <label for="urlInput" class="form-label fs-3">Scrape URL</label>
    <input type="text" class="form-control" id="urlInput" placeholder="https://thespblog.net" name="url">
</div>
<hr/>
<div class="wrapper pb-4">
    <div id="searchbox" focus></div>
    <div id="hits"></div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@meilisearch/instant-meilisearch/dist/instant-meilisearch.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@4"></script>
<script>
    const myModal = new bootstrap.Modal('#exampleModal', {
        keyboard: false,
        backdrop: 'static'
    });
    myModal.show();
    let apiKey = "";
    document.getElementById("apiKeyBtn").addEventListener("click", (e) => {
        console.log(`modal closed`);
        apiKey = document.getElementById("apiKey").value;
        console.log(`ApiKey: ${apiKey}`);
        const search = instantsearch({
            indexName: "sites",
            searchClient: instantMeiliSearch(
                window.location.href,
                apiKey,
            )
        });
        search.addWidgets([
            instantsearch.widgets.configure({
                hitsPerPage: 10,
                attributesToSnippet: ['content:50'],
            }),
            instantsearch.widgets.searchBox({
                container: "#searchbox",
                showSubmit: false,
                showReset: false,
                cssClasses: {
                    root: [
                        'w-100',
                        'mb-2',
                    ],
                    input: [
                        'form-control',
                    ],
                }
            }),
            instantsearch.widgets.infiniteHits({
                container: "#hits",
                cssClasses: {
                    list: [
                        'ps-0',
                        'list-group',
                        'list-group-flush',
                    ],
                    item: [
                        'list-group-item',
                        'mb-2',
                    ],
                    loadMore: [
                        'btn',
                        'btn-primary',
                        'mt-0',
                    ],
                },
                templates: {
                    item: `
                <div>
                <p class='fw-semibold mb-0'>
                {{#helpers.highlight}}{ "attribute": "title" }{{/helpers.highlight}}
                </p>
                <a href="{{ url }}" target="_blank">
                {{#helpers.highlight}}{ "attribute": "url" }{{/helpers.highlight}}
                </a>
                <p>
                {{#helpers.snippet}}{ "attribute": "content" }{{/helpers.snippet}}
                </p>
                </div>
              `
                }
            })
        ]);
        search.start();
        console.log(`registering url input`);
        document.getElementById("urlInput").addEventListener("keypress", (e) => {
            if (e.key !== 'Enter') {
                return
            }
            const url = e.target.value;
            e.target.setAttribute("disabled", true);
            console.log(`scraping ${url}`);
            fetch(window.location.href + "scrape?" + new URLSearchParams({
                url: url
            }))
                .then((response) => {
                    console.log(`succeeded`);
                    e.target.removeAttribute("disabled");
                    e.target.value = "";
                    setTimeout(() => {
                        console.log(`refreshing search cache`);
                        search.refresh();
                    }, 10000);
                })
                .catch((e) => {
                    alert(`could not scrape: ${e}`);
                    e.target.removeAttribute("disabled");
                    e.target.value = "";
                    setTimeout(() => {
                        console.log(`refreshing search cache`);
                        search.refresh();
                    }, 10000);
                });
        });
        console.log(`registering refresh button`);
        document.getElementById("refreshBtn").addEventListener("click", (e) => {
            console.log(`refreshing search cache`);
            search.refresh();
        });
    });


</script>
</body>
</html>